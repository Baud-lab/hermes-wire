// nextflow.config â€” SLURM + Singularity only

manifest {
  mainScript = 'main.nf'
}

/* ---------- Defaults ---------- */
process {
  executor  = 'local'
  container = 'docker://morillofe/microbiome_step4:v1'
  maxForks  = 100
  scratch   = false   // use node-local $TMPDIR, then stage-out outputs
}

/* ---------- Container Runtime: Singularity ---------- */
singularity {
  enabled    = true
  cacheDir   = "/users/abaud/fmorillo/singularity_containers/"
  autoMounts = true
  // Note: no /scratch binding; rely on shared filesystem as needed
  runOptions = "--no-home -B /nfs,/users,/tmp"
}

/* Built-in run reports */
trace    { enabled = false; file = "trace.txt" }
timeline { enabled = false; file = "timeline.html" }
report   { enabled = false; file = "report.html" }

/* Environment passthrough */
env {
  SINGULARITY_BINDPATH = "/nfs,/users,/tmp"
  PYTHONNOUSERSITE     = 1
  R_PROFILE_USER       = "/.Rprofile"
  R_ENVIRON_USER       = "/.Renviron"
}

/* ---------- Profiles ---------- */
profiles {

  singularity {
    singularity.enabled = true
    singularity.autoMounts = true
  }

  slurm_genoa {
    process {
      executor  = 'slurm'
      queue     = 'genoa64'
      cache     = 'lenient'
      cpus      = 1
      memory    = '10 GB'
      time      = '6h'
      clusterOptions = {
        task.time <= 3.h  ? '--qos=shorter' :
        task.time <= 6.h  ? '--qos=short'   :
        task.time <= 12.h ? '--qos=normal'  :
        task.time <= 24.h ? '--qos=long'    :
        task.time <= 48.h ? '--qos=vlong'   : '--qos=marathon'
      }
      withLabel: big_cpus { cpus=8; time='6h'; memory='20 GB' }
      withLabel: big_mem  { time='12h'; memory='60 GB' }
      withLabel: genesis {
        maxForks = 100
        env = [
          GENESIS_VARBLOCK     : '500',
          OPENBLAS_NUM_THREADS : '1',
          OMP_NUM_THREADS      : '1',
          MKL_NUM_THREADS      : '1'
        ]
      }
    }

    executor {
      queueSize       = 100
      submitRateLimit = '100/1min'
      pollInterval    = '1 min'
    }

    // use Singularity in this profile
    singularity.enabled = true
  }
}
